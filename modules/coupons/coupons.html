<div class="row">
    <span style="padding: 15px 0 0 15px;color: #006dcc" id="coupons-title">
        <a  href="javascript:openModule('modules/index/indexClick.html',400);" style="color: #006dcc">商户首页</a>
        &gt;&gt;<a href="javascript:openModule('modules/store/storeindex.html',101);" style="color: #006dcc">门店首页</a>
        &gt;&gt;<a href="javascript:openModule('modules/coupons/coupons.html',401);" style="color: #006dcc">门店优惠管理</a>
    </span>
    <span style="color:#114da9;margin-left: 20px;">当前门店:<span id="nowStorename"></span></span>
</div>
<div class="page-title" style="margin-top:10px;">
    <ul class="filter_ul" style="margin-left: -5px;padding: 0">
        <li><a id="button-quaninfo-create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增门店优惠</a></li>
        <li><form>
            <select id="status" style="width: 150px;height: 25px;">
                <option value="10">正常状态</option>
                <option value="0">全部</option>
                <option value="80">已删除</option>
            </select>
        </form></li>
        <li><a id="button-coupons-copy" href="javascript:void(0);"><i class="fa  fa-files-o"></i>复制优惠信息</a></li>
    </ul>
</div>
<div class="row" id="couponbox">
</div>
<div class="row" style="float: right">
    <ul class="pagination" id="pagination">
    </ul>
</div>
<div id="dialog-quan-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="900" data-height="480" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" id="quanClose" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-quan-update" class="modal-title">新增门店优惠</h4>
    </div>
    <div class="modal-body">
        <form id="form-quaninfo-update" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
            <input name="quanid" id="quanid" type="hidden">
            <input name="merchid" id="merchid" type="hidden">
            <input name="createtime" type="hidden">
            <table width="100%">
                <tbody>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >优惠券标题</label>
                            <div class="col-lg-8">
                                <input class="form-control" name="quantitle">
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >状 态</label>
                            <div class="col-lg-8" >
                                <select name="status" class="form-control" required=""   data-bv-trigger="blur"  data-bv-notempty-message="状态不能为空">
                                    <option value="10" style="color:green;">正常</option>
                                    <option value="20" style="color:#FF00FF;">待审批</option>
                                    <!--   <option value="30">隐藏</option>
                                       <option value="40">下架</option>
                                       <option value="70" style="color:red;">过期</option>-->
                                    <option value="80" style="color:red;">删除</option>
                                </select>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >赠送流量(M)</label>
                            <div class="col-lg-8" >
                                <select name="fluxpkgid" id="fluxpkgid" class="form-control">

                                </select>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >通话时长(分)</label>
                            <div class="col-lg-8" >
                                <select name="voicetimes" class="form-control">
                                    <option value="0">不赠送</option>
                                    <option value="60">60分钟 -价值4.8元</option>
                                    <option value="100">100分钟 -价值8元</option>
                                    <option value="200">200分钟 -价值16元</option>
                                    <option value="500">500分钟 -价值40元</option>
                                    <option value="1000">1000分钟 -价值80元</option>
                                </select>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >有效期限(天数)</label>
                            <div class="col-lg-8" ><input name="validday" id="validday" placeholder="为0表示长期有效" class="form-control" ></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >现金折扣或赠送礼品</label>
                            <div class="col-lg-8" ><input  name="giftname" placeholder="全场八折优惠/赠送精美礼品等" class="form-control"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >起始时间</label>
                            <div class="col-lg-8" ><input  name="starttime" id="quanstarttime" placeholder="优惠起始时间" class="form-control"></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >代金金额(元)</label>
                            <div class="col-lg-8" >
                                <input name="cashvalue" placeholder="输入赠送的代金券金额" class="form-control" ></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >截止时间</label>
                            <div class="col-lg-8" ><input  name="endtime" readonly id="endtime"  placeholder="优惠结束时间，长期有效则填0" class="form-control"></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >发行张数</label>
                            <div class="col-lg-8" ><input  name="maxcount"  placeholder="发行优惠券数量,为0表示无数张" type="number" class="form-control"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >触发优惠金额</label>
                            <div class="col-lg-8" >
                                <input name="costmoneyneed" placeholder="设置消费满多少时可使用此券" class="form-control">
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >备注说明</label>
                            <div class="col-lg-8" >
                                <input name="remark" id="remark" placeholder="备注说明" class="form-control">
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            <br>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3">
                    <button id="formbtn-quan-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>
<div id="dialog-quan-change" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="900" data-height="80" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">确定作废此优惠券吗？作废后不可恢复</h4>
    </div>
    <div class="modal-body">
        <div class="row">

        </div>
        <div class="row">
            <div class="col-lg-6" style="text-align: center">
                <button type="button" class="btn btn-primary" id="sureqx" style="margin: auto">确定</button>
            </div>
            <div class="col-lg-6" style="text-align: center">
                <button type="button" class="btn btn-primary" id="closeqx" style="margin: auto">取消</button>
            </div>
        </div>
    </div>
</div>
<!--复制优惠券到门店modal-->
<div id="dialog-copy-coupons" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false" data-width="800" style="height: 650px">
    <div class="modal-header">
        <button type="button" class="close closegoods" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title" style="text-align: center">复制到其他店铺</h4>
    </div>
    <div id="treeMenu" class="modal-body">
        <div class="form-group" style="color: grey" id="couponsname_div">
            <p>已选择门店优惠</p>
            <p id="couponsname_para">
                <span class="couponsname_span">物联卡1</span>
            </p>
        </div>
        <div class="form-group">
            <label for="checkall"><input type="checkbox" id="checkall">选择全部门店</label>
        </div>
        <div style="width: 100%;min-height: 360px;border: solid 1px gray">
        <ul id="storeTree" class="ztree" style="float:left;min-width: 350px;margin: 0;min-height: 360px;background: rgba(116, 155, 233, 0.3)">

        </ul>
            <p id="checklength"></p>
        </div>
        <button id="copyto_store" type="button" class="btn btn-theme btn-block" style="margin-top: 20px">提交</button>
    </div>
</div>

<script>
    {
        $(document).ready(function(){
            if(system_merchuser.type==10){
                $("#coupons-title").html('<a  href="javascript:openModule(\'modules/index/indexClick.html\',400);" style="color: #006dcc">商户首页</a>'+
                        '&gt;&gt;<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>' +
                        '&gt;&gt;<a href="javascript:openModule(\'modules/coupons/coupons.html\',401);" style="color: #006dcc">门店优惠管理</a>')
            }else{
                $("#coupons-title").html('<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>' +
                        '&gt;&gt;<a href="javascript:openModule(\'modules/coupons/coupons.html\',401);" style="color: #006dcc">门店优惠管理</a>')
            }
            $(".pull-left").show();
            $("#menu").show();
            $("body").removeClass("widescreen");
            //-----门店名称--------------
          /*  $.ajax({
                cache: false,
                dataType: "json",
                type: "POST",
                data:{
                    "bean":$.objectToString({storeid:common.getData('storeid')})
                },
                url: '/pipes/merchstore/query',
                error: function () {//请求失败处理函数
                    alert('请求失败');
                },
                success: function (data) {
                    if(data&&data.retcode>0){
                        alert(data.retinfo);
                    }else{
                        var rows = data.rows||[];
                        $("#nowStorename").text(rows[0].storename);
                    }
                }
            });*/
            var storename=common.getData('storename');
            $("#nowStorename").text(storename);
        });
        if (system_merchuser && system_merchuser.merchuserid) {
            var storeid = common.getData("storeid");
            var data = {
                storeid: storeid,
                status: $("#status").val()
            };
            //获取优惠券内容
            start(data);
            function start(data) {
                $.ajax({
                    url: "/pipes/merchquan/query",
                    type: "POST",
                    dataType: "JSON",
                    data: {"bean": $.objectToString(data)},
                    success: function (res) {
                        if (res && res.retcode > 0) {
                            alert(res.retinfo)
                        } else {
                            var arr = res || [];
                            if (arr.length == 0) {
                                $("#couponbox").html("<h1 style='padding: 50px'>更多优惠等待您的添加</h1>");
                                return;
                            }
                            //优惠券大于9个分页
                            var listNum = "";
                            if (arr.length > 9) {
                                if (arr.length % 9 == 0) {
                                    listNum = arr.length % 9;
                                } else {
                                    listNum = parseInt(arr.length / 9) + 1;
                                    qjarr = arr;
                                }
                                var listhtml = "";
                                for (var v = 0; v < listNum; v++) {
                                    listhtml += '<li><span class="page">' + (v + 1) + '</span></li>';
                                }
                                $("#pagination").empty();
                                $("#pagination").prepend('<li><span class="first">&laquo;</span></li>');
                                $("#pagination").append(listhtml);
                                $("#pagination").append('<li><span class="last">&raquo;</span></li>');
                                for (var i = 0; i < arr.length; i++) {
                                    for (var j = 0; j <= i; j++) {
                                        if (arr[i].createtime > arr[j].createtime) {
                                            var tmp = arr[i];
                                            arr[i] = arr[j];
                                            arr[j] = tmp;
                                        }
                                    }
                                }
                                var arrSlice = arr.slice(0, 9);
                                arrCoupon(arrSlice);
                            } else {
                                for (var t = 0; t < arr.length; t++) {
                                    for (var b = 0; b <= t; b++) {
                                        if (arr[t].createtime > arr[b].createtime) {
                                            var tmp1 = arr[t];
                                            arr[t] = arr[b];
                                            arr[b] = tmp1;
                                        }
                                    }
                                }
                                arrCoupon(arr);
                            }
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            }
            //获取流量套餐
            $.ajax({
                url: "/pipes/merchquan/fluxpkgs",
                data: {},
                dataType: "JSON",
                type: "POST",
                success: function (res) {
                    if (res && res.retcode > 0) {
                        alert(res.retinfo)
                    } else {
                        var _html = "";
                        $("#fluxpkgid").empty();
                        for (var i = 0; i < res.length; i++) {
                            _html += '<option value=' + res[i].fluxpkgid + '>' + res[i].pkgtitle + '</option>';
                        }
                        $("#fluxpkgid").html('<option value="0">不赠送流量</option>');
                        $("#fluxpkgid").append(_html);
                    }
                },
                error: function (err) {
                    console.log(err);
                }
            });
            //点击分页的页码
            $("#pagination").on("click", ".page", function () {
                var page = 0;
                page = $(this).text() * 9;
                for (var i = 0; i < qjarr.length; i++) {
                    for (var j = 0; j <= i; j++) {
                        if (qjarr[i].createtime > qjarr[j].createtime) {
                            var tmp = qjarr[i];
                            qjarr[i] = qjarr[j];
                            qjarr[j] = tmp;
                        }
                    }
                }
                var arr = qjarr.slice(page - 9, page);
                arrCoupon(arr);
            });
            $("#pagination").on('click', ".first", function () {
                for (var i = 0; i < qjarr.length; i++) {
                    for (var j = 0; j <= i; j++) {
                        if (qjarr[i].createtime > qjarr[j].createtime) {
                            var tmp = qjarr[i];
                            qjarr[i] = qjarr[j];
                            qjarr[j] = tmp;
                        }
                    }
                }
                var arr = qjarr.slice(0, 9);
                arrCoupon(arr);
            });
            $("#pagination").on('click', ".last", function () {
                var arr = "";
                for (var i = 0; i < qjarr.length; i++) {
                    for (var j = 0; j <= i; j++) {
                        if (qjarr[i].createtime > qjarr[j].createtime) {
                            var tmp = qjarr[i];
                            qjarr[i] = qjarr[j];
                            qjarr[j] = tmp;
                        }
                    }
                }
                if (qjarr.length % 9 == 0) {
                    arr = qjarr.slice(qjarr.length - 9, qjarr.length);
                } else {
                    arr = qjarr.slice(qjarr.length - qjarr.length % 9, qjarr.length);
                }

                arrCoupon(arr);
            });
            //处理优惠券展示
            function arrCoupon(arr) {
                $.ajax({
                    url: "/pipes/merchquan/fluxpkgs",
                    data: {},
                    dataType: "JSON",
                    type: "POST",
                    async: false,
                    success: function (res) {
                        if (res && res.retcode > 0) {
                            alert(res.retinfo);
                        } else {
                            qjflux = res || [];
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
                var _html = "", validtime = "", status = "", fluxpkgid = "", giftname = "";
                $("#couponbox").empty();
                for (var i = 0; i < arr.length; i++) {
                    //有效期
                    if (arr[i].endtime == 0) {
                        validtime = "自" + time(arr[i].starttime) + "起长期永久有效";
                    } else {
                        validtime = time(arr[i].starttime) + "至" + time(arr[i].endtime);
                    }
                    //状态判断
                    if (arr[i].status === 10) {
                        status = "<font color=green>正常</font>";
                    } else if (arr[i].status === 20) {
                        status = "<font color=#FF00FF>待审批</font>";
                    } else if (arr[i].status === 40) {
                        status = "冻结";
                    } else if (arr[i].status === 50) {
                        status = "隐藏";
                    } else if (arr[i].status === 60) {
                        status = "关闭";
                    } else if (arr[i].status === 70) {
                        status = "<font color=red>过期</font>";
                    } else if (arr[i].status === 80) {
                        status = "<font color=red>删除</font>";
                    } else {
                        status = "<font color=red>未知</font>";
                    }
                    //流量获取
                    var fluxpkgid = "";
                    for (var j = 0; j < qjflux.length; j++) {
                        if (arr[i].fluxpkgid == qjflux[j].fluxpkgid) {
                            fluxpkgid = qjflux[j].pkgtitle
                        }
                    }
                    //赠送礼品
                    if (arr[i].giftname) {
                        giftname = arr[i].giftname
                    } else {
                        giftname = '无'
                    }
                    //有效期
                    var validday = "";
                    if (arr[i].validday != 0) {
                        validday = "(" + arr[i].validday + "天)"
                    }
                    //---------------------------------
                    var endtime = "";
                    if (arr[i].endtime == 0) {
                        endtime = 0
                    } else {
                        endtime = time(arr[i].endtime)
                    }
                    var str = arr[i].quantitle + '?/' +
                            arr[i].status + '?/' + arr[i].fluxpkgid + '?/' + time(arr[i].starttime) + '?/' +
                            endtime + '?/' + arr[i].voicetimes + '?/' + arr[i].cashvalue + '?/' + arr[i].validday + '?/' + giftname +
                            '?/' + arr[i].quanid;
                    var statustext = "";
                    if (arr[i].status == 80) {
                        statustext = '<button style="background: none;border: none;color: red;" value=' + str + '>已删除</button>'
                    } else {
                        statustext = '<button class="button-quaninfo-update" style="background: none;border: none;color: blue;" value=' + str + '>删除</button>'
                    }
                    //---流量 话费 礼物 语音 为空值时则不展示
                    var fluxhtml = "", gifthtml = "", voicehtml = "", cashhtml = "", remarkhtml = "";
                    if (fluxpkgid) {
                        fluxhtml = '<div class="col-lg-6"><p style="margin-top: 10px">赠送流量:<span>' + fluxpkgid + '</span></p></div>';
                    } else {
                        fluxhtml = "";
                    }
                    if (giftname != '无') {
                        gifthtml = '<div class="col-lg-6"><p style="margin-top: 10px">赠送礼品:<span>' + giftname + '</span></p></div>'
                    } else {
                        gifthtml = '';
                    }
                    if (arr[i].voicetimes != 0) {
                        voicehtml = '<div class="col-lg-6"><p style="margin-top: 10px">通话分钟:<span>' + arr[i].voicetimes / 60 + '分钟</span></p></div>'
                    } else {
                        voicehtml = '';
                    }
                    if (arr[i].cashvalue != 0) {
                        cashhtml = '<div class="col-lg-6"><p style="margin-top: 10px">代金券:<span>' + arr[i].cashvalue / 100 + '元</span></p></div>';
                    } else {
                        cashhtml = '';
                    }
                    if (arr[i].maxcount == 0) {
                        arr[i].maxcount = "不限张数";
                    }
                    //------------------------------
                    _html+='<div class=" col-lg-4">'+
                            '<div class="panel-box" style="padding: 5px;position: relative;background: #f7c16c;color: white;height: 200px;" id=" storebasic">'+
                            '<div class= "row">'+
                            '<div class="page-header" style="padding: 10px;margin : 0;">'+
                            '<h5 style="margin-left: 20px;color: white;display: inline-block">' +
                            '<button class="quanidbtn" style="background: none;border: none;display: none" value="'+arr[i].quanid+'"><i class="fa fa-check-circle-o" style="margin-right: 5px;font-size: 24px;">' +
                            '</i></button>'+arr[i].quantitle+'<small style="margin-left: 15px;color: white " >('+ status+')</small></h5>'+
                            '<p style="display: inline-block;position: absolute;right: 0; " >'+ statustext+'</p></div></div >'+
                            '<div class="row" style="margin-left: 10px;" >'+ fluxhtml + gifthtml + voicehtml + cashhtml +' </div >'+
                            '<div class="row" style="margin-left: 10px;margin-bottom: 20px" >'+
                            '<div class="col-lg-6"><p> 发行张数:'+arr[i].maxcount +' </p></div >'+ remarkhtml +' </div>' +
                            '<div class="row" style="display: inline-block;position: absolute;bottom: 0;right: 20px;">' +
                            '<p style="display: inline-block"> 有效期:'+ validtime +' <span >'+ validday +' </span></p></div></div></div>';
                }
                $("#couponbox").html(_html);
            }
            //点击新增优惠券
            $("#button-quaninfo-create").bind("click", function () {
                $("#form-quaninfo-update").form('reset');
                $("#quanid").val("");
                couponsvalidator();
                $('#dialog-quan-update').modal('show');
            });
            //--------------点击修改优惠券------------------------------
            $("#closeqx").click(function(){
                $("#dialog-quan-change").modal('hide');
            });
            $("#couponbox").on('click', '.button-quaninfo-update', function(){
                var str = $(this).val();
                var arr = str.split("?/");
                var obj ={};
                obj.quantitle =arr[0];
                obj.status =arr[1];
                obj.fluxpkgid =arr[2];
                obj.starttime =arr[3];
                obj.endtime =arr[4];
                obj.voicetimes =arr[5];
                obj.cashvalue =arr[6];
                obj.validday =arr[7];
                obj.giftname =arr[8];
                obj.quanid =arr[9];
                obj.storeid =common.getData('storeid');
                obj.merchid =system_merchuser.merchid;
                var data1 = obj;
                data1.starttime = datetime(data1.starttime);
                if(data1.endtime==0){
                    data1.endtime = 0
                }else{
                    data1.endtime = datetime(data1.endtime);
                }
                data1.status= 80;
                $('#dialog-quan-change').modal('show');
                $("#sureqx").click(function () {
                    var cols = ["status"];
                    var json = {
                        "bean": $.objectToString(data1),
                        "cols": $.objectToString(cols)
                    };
                    $.ajax({
                        url: "/pipes/merchquan/update",
                        data: json,
                        dataType: "JSON",
                        type: "POST",
                        success: function (res) {
                            if (res && res.retcode > 0) {
                                alert(res.retinfo);
                            } else {
                                $("#dialog-quan-change").modal('hide');
                                $(this).html('<font style="color: red">已删除</font>');
                                start(data);
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                })
            });
            //优惠券中有效日期选择
            timeChange();
            function timeChange() {
                var t = new Date().toJSON();
                var t1 = new Date();
                var t2 = new Date(t1);
                t2.setDate(t1.getFullYear() + 5);
                t2 = t2.toJSON();
                $("#quanstarttime").datetimepicker({
                    format: "yyyy-mm-dd", //设置时间格式，默认值: 'mm/dd/yyyy'
                    weekStart: 0, //一周从哪一天开始。0（星期日）到6（星期六）,默认值0
                    startDate: new Date(), //可以被选择的最早时间
                    endDate: new Date(t2), //可以被选择的最晚时间
                    daysOfWeekDisabled: "", //禁止选择一星期中的某些天，例子中这样是禁止选择周六和周日
                    autoclose: true, //当选择一个日期之后是否立即关闭此日期时间选择器
                    startView: 2, //点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
                    minView: 2, //插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
                    maxView: 4, //同理
                    todayBtn: true, //是否在底部显示“今天”按钮
                    todayHighlight: true, //是否高亮当前时间
                    keyboardNavigation: true, //是否允许键盘选择时间
                    language: 'zh-CN', //选择语言，前提是该语言已导入
                    forceParse: true, //当选择器关闭的时候，是否强制解析输入框中的值。也就是说，当用户在输入框中输入了不正确的日期，选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中
                    minuteStep: 5, //分钟的间隔
                    pickerPosition: "top-left", //显示的位置，还支持bottom-left
                    viewSelect: 2, //默认和minView相同
                    showMeridian: true, //是否加上网格
                    initialDate: new Date(t),//初始化的时间
                    zIndex: 1080
                }).on('changeDate', function () {
                    endvalue();
                });
                $("#validday").on('change', function () {
                    endvalue();
                });
                function endvalue() {
                    if ($("#validday").val() == 0) {
                        $("#endtime").val("0");
                    } else {
                        var v = $("#validday").val()-1;
                        var t = $("#quanstarttime").val();
                        t = datetime(t);
                        var t2 = new Date(t);
                        var t2 = t2.setDate(t2.getDate() + Number(v));
                        var year = new Date(t2).getFullYear();
                        var month = new Date(t2).getMonth() + 1;
                        var date = new Date(t2).getDate();
                        if (month < 10) {
                            month = "0" + month;
                        }
                        if (date < 10) {
                            date = "0" + date;
                        }
                        var result = year + "-" + month + "-" + date;
                        $("#endtime").val(result);
                    }
                }
            }
            function time(date) {
                var year = new Date(date).getFullYear();
                var month = new Date(date).getMonth() + 1;
                var date1 = new Date(date).getDate();
                if (month < 10) {
                    month = "0" + month;
                }
                if (date1 < 10) {
                    date1 = "0" + date1;
                }
                var result = year + "-" + month + "-" + date1;
                return result;
            }
            //--------------新增优惠券提交------------------------------
            $("#formbtn-quan-update").click(function () {
                $(this).attr("disabled",true);
                var form = $("#form-quaninfo-update");
                var json = form.serializeJson();
                json.starttime = datetime(json.starttime);
                if (json.endtime == 0) {
                    json.endtime = 0;
                } else {
                    json.endtime = datetime(json.endtime);
                    json.endtime = json.endtime + 24 * 60 * 60 * 1000 - 1;
                }
                json.voicetimes = json.voicetimes * 60;
                json.cashvalue = json.cashvalue * 100;
                json.costmoneyneed = json.costmoneyneed*100;
                json.storeid = storeid;
                //-----去json数据中的空格-----------------
                var json1 = {};
                $.each(json, function (key, value) {
                    value = (value + "").replace(/\s/g, '');
                    json1[key] = value;
                });
                json = json1;
                var data1 = {"bean": $.objectToString(json)};
                $('#form-quaninfo-update').bootstrapValidator('validate');
                if ($('#form-quaninfo-update').data('bootstrapValidator').isValid()) {
                    $.ajax({
                        url: "/pipes/merchquan/update",
                        data: data1,
                        dataType: "JSON",
                        type: "POST",
                        success: function (res) {
                            $("#formbtn-quan-update").removeAttr("disabled");
                            if (res && res.retcode > 0) {
                                alert(res.retinfo);
                            } else {
                                $("#dialog-quan-update").modal('hide');
                                $('#form-quaninfo-update').data('bootstrapValidator', null);
                                start(data);
                            }
                        },
                        error: function (error) {
                            $("#formbtn-quan-update").removeAttr("disabled");
                            console.log(error);
                            alert("请求失败");
                        }
                    });
                }else{
                    $("#formbtn-quan-update").removeAttr("disabled");
                }
            });
            //优惠券信息验证
            function couponsvalidator() {
                $('#form-quaninfo-update').bootstrapValidator({
                    message: 'This value is not valid',
                    feedbackIcons: {
                        /*输入框不同状态，显示图片的样式*/
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        /*验证*/
                        quantitle: {
                            /*键名和input name值对应*/
                            message: 'The quantitle is not valid',
                            validators: {
                                notEmpty: {
                                    /*非空提示*/
                                    message: '优惠券标题不能为空'
                                }
                            }
                        },
                        fluxpkgid: {
                            message: '',
                            validators: {
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        maxcount: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "发行张数不能为空,无张数限制可填0"
                                },
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        voicetimes: {
                            message: '',
                            validators: {
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        cashvalue: {
                            message: '',
                            validators: {
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        validday: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "有效期不能为空,长久有效可填0"
                                },
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        starttime: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "请选择开始日期"
                                }
                            }
                        },
                        costmoneyneed: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "无需触发金额可填0"
                                },
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        }
                    }
                });
            }
            //将日历中取出的值转换成后台所需的格式
            function datetime(time) {
                time1 = time.replace(/-/g, "/");
                time2 = new Date(time1).getTime();
                return time2;
            }
            $("#quanClose").click(function(){
                $('#form-quaninfo-update').data('bootstrapValidator', null);
            });
            //------------选择不同状态的优惠券进行筛选------------------
            $("#status").change(function () {
                var storeid = common.getData("storeid");
                var data = {
                    storeid: storeid,
                    status: $("#status").val()
                };
                //获取优惠券内容
                start(data);
            });
            //-----------复制优惠券---------------------------------
            $("#couponbox").on("click",".col-lg-4",function(){
                $(this).toggleClass('activeCopy');
                if($(this).hasClass('activeCopy')){
                    $(this).find('.panel-box').css("background","rgba(247, 108, 108, 0.95)");
                    $(this).find(".quanidbtn").show();
                }else{
                    $(this).find('.panel-box').css("background","#f7c16c");
                    $(this).find(".quanidbtn").hide();
                }
            });
            //点击复制优惠按钮
            $("#button-coupons-copy").click(function(){
                if($(".col-lg-4").hasClass('activeCopy')){
                    var arr = $('.activeCopy').find('.quanidbtn');
                    var quanidarr = [];
                    var quantitle = [];
                    for(var i=0;i<arr.length;i++){
                        quanidarr.push($(arr[i]).val());
                        quantitle.push(arr.eq(i).parent().text());
                    }
                    console.log(quanidarr);
                    $("#couponsname_para").empty();
                    for(var i=0;i<quanidarr.length;i++){
                        $("#couponsname_para").append('<span class="couponsname_span" data-id="'+quanidarr[i]+'">'+quantitle[i]+'</span>')
                    }
                    $.ajax({
                        url:"/pipes/merchstore/query",
                        data:{"bean":$.objectToString({merchid:system_merchuser.merchid})},
                        type:"POST",
                        dataType:"JSON",
                        success:function(data){
                            console.log(data.rows);
                            var arr = data.rows;
                            var _li='';
                            for(var i=0;i<arr.length;i++){
                                _li+='<li><label><input type="checkbox">' +
                                        '<input type="hidden" class="storeid" value="'+arr[i].store36id+'">'+arr[i].storename+'</label></li>'

                            }
                            $("#storeTree").html(_li);
                            $("#dialog-copy-coupons").modal('show');
                        },
                        error:function(err){
                            console.log(err);
                        }
                    });
                }else{
                   alert("请选择您想要复制的优惠券");
                }
            });
            //---------------------ztree--------------------------------
         /*   var settings = {
                data : {
                    key:{
                        name:"storename"
                    },
                    simpleData : {
                        enable : true,
                        isSimpleData : true, //数据是否采用简单 Array 格式，默认false
                        treeNodeKey : "id", //在isSimpleData格式下，当前节点id属性
                        treeNodeParentKey : "pId", //在isSimpleData格式下，当前节点的父节点id属性
                        showLine : true, //是否显示节点间的连线
                        checkable : true,
                        rootPId : 0,
                        expandFlag :true
                        //不设置rootId，则树栏目的pId则为null
                    }
                },
                edit : {
                    enable:true,
                    showRemoveBtn:false,
                    showRenameBtn:false,
                    drag:{
                        isCopy:true,
                        isMove:true,
                        prev:true,
                        next:true,
                        inner:true
                    }
                },
                check:{
                    enable:true,
                    autoCheckTrigger:true,
                    chkStyle : "checkbox",
                    chkboxType : { "Y" : "s", "N" : "ps" }
                }
            };
            function zTreeInit(settings,zNodes){
                $.fn.zTree.init($("#storeTree"),settings,zNodes);
                var treeObj = $.fn.zTree.getZTreeObj("storeTree");
                treeObj.expandAll(true);
            }*/
            //----------------------下拉加载--------------------------
            var loading = false;//是否正在加载
            var current = 1;//默认当前是第一页
            var select_ajax = true;
            $("#storeTree").scroll(function () {
                if (loading) //如果正在请求 直接返回
                    return;
                var scrollTop = jQuery(this).scrollTop();
                var scrollHeight = jQuery('#storeTree').height();
                var windowHeight = jQuery(this).height();
                if (scrollTop + windowHeight >= scrollHeight - 100) {
                    if (select_ajax) {
                        getMoreData();//select_ajax为false ,表示没有更多了，不能请求ajax
                    }
                }
            });
            //下拉加载列表
            function getMoreData() {
                loading = true;
                var html = "";
                current++;
                jQuery.ajax({
                    type: "post",
                    cache: false,
                    dataType: "JSON",
                    data: {
                        "bean":$.objectToString({merchid:system_merchuser.merchid}),
                        "flipper": "{limit:20,offset:"+(current-1)*20+"}",
                        "order": "DESC",
                        "start": current*20,
                        "length": 20,
                        "sort": "createtime"
                    },
                    url: "/pipes/merchstore/query",
                    success: function (data) {
                        var arr = data.rows;
                        var _li='';
                        for(var i=0;i<arr.length;i++){
                            _li+='<li><label><input type="checkbox">' +
                                 '<input type="hidden" class="storeid" value="'+arr[i].store36id+'">'+arr[i].storename+'</label></li>';
                        }
                        $("#storeTree").append(_li);
                        if (data.total>current*20) {
                            loading = false; //loding=false 表示下次继续可以请求
                        } else {
                            loading = true;
                            $("#storeTree").append('<li style="text-align: center">没有更多数据了</li>');
                        }
                    },
                    error: function (data) {
                        alert("数据加载失败");
                    }
                });
            }
            //----------点击门店中的全选----------------------
            $("#checkall").click(function(){
                var isChecked = $(this).prop("checked");
                $("#storeTree :checkbox").prop("checked", isChecked);
                var checklength =  $("#storeTree").find('input[type=checkbox]:checked').length;
                $("#checklength").html('已选择'+checklength+'家门店');
            });
            $('#storeTree').on('click','input[type=checkbox]',function(){
                var checklength =  $("#storeTree").find('input[type=checkbox]:checked').length;
                var length = $("#storeTree").find('input[type=checkbox]').length;
                $("#checklength").html('已选择'+checklength+'家门店');
                if(checklength==length){
                    console.log("全选");
                    $("#checkall").prop("checked", true);
                }else{
                    $("#checkall").prop("checked", false);
                }
            });
            $("#copyto_store").click(function(){
                $(this).attr("disabled",true);
                var arr = $("#storeTree").find('input[type=checkbox]:checked').next('.storeid');
                var storeid = [];
                var nowstoreid = parseInt(common.getData("storeid")).toString(36);
                console.log(nowstoreid);
                for(var i=0;i<arr.length;i++){
                    if(arr.eq(i).val()==nowstoreid){
                        continue;
                    }
                    storeid.push(arr.eq(i).val());
                }
                var couponsarr = $(".couponsname_span");
                var couponsid=[];
                for(var j=0;j<couponsarr.length;j++){
                    couponsid.push(couponsarr.eq(j).data('id'));
                }
                console.log(couponsid);
                console.log(storeid);
                if(storeid.length==0){
                    alert('您还没有选择门店');
                    $("#copyto_store").removeAttr('disabled')
                }else{
                    var data = {
                        "store36ids":storeid,
                        "quanids":couponsid
                    };
                    $.get('/pipes/merchquan/copyquan2store?store36ids=['+storeid+"]&quanids=["+couponsid+"]",function(res){
                        console.log(res);
                        res = JSON.parse(res);
                        if(res.retcode===0){
                            alert('优惠券复制成功');
                            $("#dialog-copy-coupons").modal('hide');
                            $('#couponbox').find('.panel-box').css("background","#f7c16c");
                            $('#couponbox').find(".quanidbtn").hide();
                        }
                        $("#copyto_store").removeAttr('disabled');
                    })
                }
            });

        }
    }
</script>