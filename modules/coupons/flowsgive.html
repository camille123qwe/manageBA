<div class="row">
    <span style="padding: 15px 0 0 15px;color: #006dcc" id="flowsgive-title"></span>
    <span style="color:#114da9;margin-left: 20px;">当前门店:<span id="nowStorename"></span></span>
</div>
<div class="page-title" style="margin-top:10px;">
    <ul class="filter_ul" style="margin: 0;padding: 0">
        <li><a id="button-giveinfo-create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增赠送信息</a></li>
        <li><a id="button-giveinfo-update" href="javascript:void(0);"><i class="fa fa-edit"></i>更改赠送信息</a></li>
        <li><a id="button-goods-copy" href="javascript:void(0);"><i class="fa  fa-files-o"></i>复制赠送信息(只可选择一条)</a></li>
    </ul>
</div>
<div class="panel-box">
    <div class="table-responsive" >
        <table id="table-flowsgive-sheet" class="table" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th></th>
                <th>分享赠送金额条件</th>
                <th>流量</th>
                <th>通话时长</th>
                <th>代金券</th>
                <th>礼品</th>
                <th>有效天数</th>
                <th>状态</th>
                <th>创建时间</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="dialog-flowsgive-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="900" data-height="480" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" id="flowsgiveClose" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-flowsgive-update" class="modal-title">分享赠送信息</h4>
    </div>
    <div class="modal-body">
        <form id="form-flowsgive-update" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
            <input name="awardid" id="awardid" type="hidden">
            <input name="merchid" id="merchid" type="hidden">
            <input name="storeid" id="storeid" type="hidden">
            <input name="createtime" type="hidden">
            <table width="100%">
                <tbody>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >赠送流量(M)</label>
                            <div class="col-lg-8" >
                                <select name="fluxpkgid" id="fluxpkgid" class="form-control">

                                </select>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >状 态</label>
                            <div class="col-lg-8" >
                                <select name="status" class="form-control" required=""   data-bv-trigger="blur"  data-bv-notempty-message="状态不能为空">
                                    <option value="10" style="color:green;">正常</option>
                                    <option value="20" style="color:#FF00FF;">待审批</option>
                                    <option value="80" style="color:red;">删除</option>
                                </select>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >奖励信息</label>
                            <div class="col-lg-8" ><input  name="awardinfo" placeholder="不赠送则不填" class="form-control"></div>
                        </div>
                    </td>
                     <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >通话时长(分)</label>
                            <div class="col-lg-8" >
                                <select name="voicetimes" class="form-control">
                                    <option value="0">不赠送</option>
                                    <option value="60">60分钟 -价值4.8元</option>
                                    <option value="100">100分钟 -价值8元</option>
                                    <option value="200">200分钟 -价值16元</option>
                                    <option value="500">500分钟 -价值40元</option>
                                    <option value="1000">1000分钟 -价值80元</option>
                                </select>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                     <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >有效期限(天数)</label>
                            <div class="col-lg-8" ><input name="validday" id="validday" placeholder="为0表示长期有效" class="form-control" ></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >代金金额(元)</label>
                            <div class="col-lg-8" ><input name="cashvalue" placeholder="输入赠送的代金券金额" class="form-control" ></div>
                        </div>
                    </td>
                </tr>
                <tr>
                      <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >起始时间</label>
                            <div class="col-lg-8" ><input  name="starttime" id="quanstarttime" placeholder="优惠起始时间" class="form-control"></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >截止时间</label>
                            <div class="col-lg-8" ><input  name="endtime" readonly id="endtime"  placeholder="优惠结束时间，长期有效则填0" class="form-control"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >触发优惠金额</label>
                            <div class="col-lg-8" >
                                <input name="ifmoneyneed" placeholder="输入0，则无需到店消费即可获得优惠" class="form-control">
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >备注说明</label>
                            <div class="col-lg-8" >
                                <input name="remark" id="remark" placeholder="备注说明" class="form-control">
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            <br>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3">
                    <button id="formbtn-flowsgive-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>
<!--复制分享信息到门店modal-->
<div id="dialog-copy-goods" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false" data-width="800" style="height: 650px">
    <div class="modal-header">
        <button type="button" class="close closegoods" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title" style="text-align: center">复制到其他店铺</h4>
    </div>
    <div id="treeMenu" class="modal-body">
        <!--  <ul id="treeMenuUl" style="height: 25px; line-height: 25px;font-size: 16px; margin: 0;padding: 0;">
              <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="1">添加</li>
              <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="3">删除</li>
              <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="4">查看</li>
          </ul>-->
        <div class="form-group" style="color: grey" id="goodname_div">
            <p>已选择赠送信息</p>
            <p id="sharesname_para">
                <span class="sharesname_span">物联卡1</span><span class="sharesname_span">物联卡2</span><span class="sharesname_span">物联卡3</span>
            </p>
        </div>
        <div class="form-group">
            <label for="checkall"><input type="checkbox" id="checkall">选择全部门店</label>
        </div>
        <div style="width: 100%;min-height: 360px;border: solid 1px gray">
            <ul id="storeTree" class="ztree" style="min-width: 350px;float: left;margin: 0;background: rgba(116, 155, 233, 0.3)">

            </ul>
            <p id="checklength"></p>
        </div>
        <button id="copyto_store" type="button" class="btn btn-theme btn-block" style="margin-top: 20px">提交</button>
    </div>
</div>

<script>
    $(document).ready(function(){
        if(system_merchuser.type==10){
            $("#flowsgive-title").html('<a  href="javascript:openModule(\'modules/index/indexClick.html\',400);" style="color: #006dcc">商户首页</a>'+
                    '&gt;&gt;<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>' +
                    '&gt;&gt;<a href="javascript:openModule(\'modules/coupons/flowsgive.html\',504);" style="color: #006dcc">分享赠送管理</a>')
        }else{
            $("#flowsgive-title").html('<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>' +
                    '&gt;&gt;<a href="javascript:openModule(\'modules/coupons/flowsgive.html\',504);" style="color: #006dcc">分享赠送管理</a>')
        }
        //-----门店名称--------------
      /*  $.ajax({
            cache: false,
            dataType: "json",
            type: "POST",
            data:{
                "bean":$.objectToString({storeid:common.getData('storeid')})
            },
            url: '/pipes/merchstore/query',
            error: function () {//请求失败处理函数
                alert('请求失败');
            },
            success: function (data) {
                if(data&&data.retcode>0){
                    alert(data.retinfo);
                }else{
                    var rows = data.rows||[];
                    $("#nowStorename").text(rows[0].storename);
                }
            }
        });*/
        var storename=common.getData('storename');
        $("#nowStorename").text(storename);
    });
    if (system_merchuser && system_merchuser.merchuserid) {
        var storeid = common.getData("storeid");
        var data = {
            storeid: storeid
        };
          //获取流量套餐
            $.ajax({
                url: "/pipes/merchquan/fluxpkgs",
                data: {},
                dataType: "JSON",
                type: "POST",
                success: function (res) {
                    if (res && res.retcode > 0) {
                        alert(res.retinfo)
                    } else {
                        var _html = "";
                        $("#fluxpkgid").empty();
                        for (var i = 0; i < res.length; i++) {
                            _html += '<option value=' + res[i].fluxpkgid + '>' + res[i].pkgtitle + '</option>';
                        }
                        $("#fluxpkgid").html('<option value="0">不赠送流量</option>');
                        $("#fluxpkgid").append(_html);
                    }
                },
                error: function (err) {
                    console.log(err);
                }
            });
        //商品列表
        var mtable = $('#table-flowsgive-sheet').dataTable({
            ajax: {
                url: "/pipes/merchshare/queryshareaward",
                dataSrc:"data",
                data: function (f) {
                    f.bean = JSON.stringify(data);
                    f.sort = 'createtime';
                    f.order = 'DESC';
                }
            },
            columnDefs: [
                {
                    className: 'select-checkbox',
                    targets: 0
                }
            ],
            columns: [
                {"data":"",render:$.defrender},
                {"data": "ifmoneyneed", render: function (value) {
                    if(value){
                        value = value/100;
                        return value +"元"
                    }
                }},
                {"data": "fluxpkgid", render: function (value,type,full) {
                    if(value){
                        return full.fluxPackage.pkgtitle;
                    }else{
                        return "无";
                    }

                }},
                {"data": "voicetimes", render:function (value) {
                    if(value){
                        return value/60+"分钟";
                    }else{
                        return "无";
                    }
                }},
                {"data": "cashvalue", render:function (value) {
                    if(value){
                        value = value/100;
                        return value+"元";
                    }else{
                        return "无";
                    }
                }},
                {"data": "awardinfo", render: function (value) {
                    if(value){
                        return value;
                    }else{
                        return "无";
                    }
                }},
                {"data": "validday", render: function(value,type,full){
                    if (full.endtime == 0) {
                        return "自" + time(full.starttime) + "起长期永久有效";
                    } else {
                        return time(full.starttime) + "至" + time(full.endtime)+"("+value+"天)";
                    }
                }},
                {"data": "status", render: defStatusRender},
                {"data": "createtime", render:  Date.DateFormatter}
            ]
        });
        //点击新增分享信息
        $("#button-giveinfo-create").bind("click", function () {
            $("#form-flowsgive-update").form('reset');
            $("#awardid").val("");
            flowsgivevalidator();
            $('#dialog-flowsgive-update').modal('show');
        });
        //--------------点击修改分享信息------------------------------
        $("#button-giveinfo-update").click(function(){
            var data = mtable.api(true).row({selected: true}).data();
            if (!data || !data.awardid) {
                alert("请选择一条记录！");
                return;
            }
            $("#form-flowsgive-update").form('reset');
            flowsgivevalidator();
            data.cashvalue = data.cashvalue/100;
            data.ifmoneyneed = data.ifmoneyneed/100;
            data.voicetimes = data.voicetimes/60;
            data.starttime = time(data.starttime).replace(/\//g,"-");
            if(data.endtime==0){
                data.endtime = 0
            }else{
                data.endtime = time(data.endtime).replace(/\//g,"-");
            }
            $("#form-flowsgive-update").form('load', data);
            $('#dialog-flowsgive-update').modal('show');

        });
        //--------------新增&&修改分享信息提交------------------------------
        $("#formbtn-flowsgive-update").click(function () {
            var form =$("#form-flowsgive-update");
            var json = form.serializeJson();
            json.storeid = storeid;
            var data = "";
            json.starttime = datetime(json.starttime);
            if(json.endtime==0){
                json.endtime = 0
            }else{
                json.endtime = datetime(json.endtime);
            }
            json.cashvalue = json.cashvalue *100;
            json.ifmoneyneed = json.ifmoneyneed *100;
            json.voicetimes = json.voicetimes*60;
            //-----去json数据中的空格-----------------
            var json1= {};
            $.each(json,function(key,value){
                value = (value + "").replace(/\s/g,'');
                json1[key] = value;
            });
            json = json1;
            //---------------------------------
            var data = "";
            if(json.awardid==""){
                data = {"bean":$.objectToString(json)}
            }else{
                var cols = [];
                for(key in json){
                    if(key=="createtime"||key=="awardid"){
                        continue
                    }
                    cols.push(key);
                }
                data = {
                    "bean":$.objectToString(json),
                    "cols":$.objectToString(cols)
                }
            }
            $('#form-flowsgive-update').bootstrapValidator('validate');
            if( $('#form-flowsgive-update').data('bootstrapValidator').isValid()) {
                $.ajax({
                    url: "/pipes/merchshare/updateshareaward",
                    data: data,
                    dataType: "JSON",
                    type: "POST",
                    success: function (data) {
                        if (data && data.retcode > 0) {
                            alert(data.retinfo)
                        } else {
                            $("#dialog-flowsgive-update").modal('hide');
                            mtable.api(true).draw(false); 
                            $('#form-flowsgive-update').data('bootstrapValidator', null);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }
        });
          //优惠券中有效日期选择
            timeChange();
            function timeChange() {
                var t = new Date().toJSON();
                var t1 = new Date();
                var t2 = new Date(t1);
                t2.setDate(t1.getFullYear() + 5);
                t2 = t2.toJSON();
                $("#quanstarttime").datetimepicker({
                    format: "yyyy-mm-dd", //设置时间格式，默认值: 'mm/dd/yyyy'
                    weekStart: 0, //一周从哪一天开始。0（星期日）到6（星期六）,默认值0
                    startDate: new Date(), //可以被选择的最早时间
                    endDate: new Date(t2), //可以被选择的最晚时间
                    daysOfWeekDisabled: "", //禁止选择一星期中的某些天，例子中这样是禁止选择周六和周日
                    autoclose: true, //当选择一个日期之后是否立即关闭此日期时间选择器
                    startView: 2, //点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
                    minView: 2, //插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
                    maxView: 4, //同理
                    todayBtn: true, //是否在底部显示“今天”按钮
                    todayHighlight: true, //是否高亮当前时间
                    keyboardNavigation: true, //是否允许键盘选择时间
                    language: 'zh-CN', //选择语言，前提是该语言已导入
                    forceParse: true, //当选择器关闭的时候，是否强制解析输入框中的值。也就是说，当用户在输入框中输入了不正确的日期，选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中
                    minuteStep: 5, //分钟的间隔
                    pickerPosition: "top-left", //显示的位置，还支持bottom-left
                    viewSelect: 2, //默认和minView相同
                    showMeridian: true, //是否加上网格
                    initialDate: new Date(t),//初始化的时间
                    zIndex: 1080
                }).on('changeDate', function () {
                    endvalue();
                });
                $("#validday").on('change', function () {
                    endvalue();
                });
                function endvalue() {
                    if ($("#validday").val() == 0) {
                        $("#endtime").val("0");
                    } else {
                        var v = $("#validday").val();
                        var t = $("#quanstarttime").val();
                        t = datetime(t);
                        var t2 = new Date(t);
                        var t2 = t2.setDate(t2.getDate() + Number(v));
                        var year = new Date(t2).getFullYear();
                        var month = new Date(t2).getMonth() + 1;
                        var date = new Date(t2).getDate();
                        if (month < 10) {
                            month = "0" + month;
                        }
                        if (date < 10) {
                            date = "0" + date;
                        }
                        var result = year + "-" + month + "-" + date;
                        $("#endtime").val(result);
                    }
                }
            }
            function time(date) {
                var year = new Date(date).getFullYear();
                var month = new Date(date).getMonth() + 1;
                var date1 = new Date(date).getDate();
                if (month < 10) {
                    month = "0" + month;
                }
                if (date1 < 10) {
                    date1 = "0" + date1;
                }
                var result = year + "-" + month + "-" + date1;
                return result;
            }
            //分享信息验证
            function flowsgivevalidator() {
                $('#form-flowsgive-update').bootstrapValidator({
                    message: 'This value is not valid',
                    feedbackIcons: {
                        /*输入框不同状态，显示图片的样式*/
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        voicetimes: {
                            message: '',
                            validators: {
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        cashvalue: {
                            message: '',
                            validators: {
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        validday: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "有效期不能为空,长久有效可填0"
                                },
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        },
                        starttime: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "请选择开始日期"
                                }
                            }
                        },
                        ifmoneyneed: {
                            message: '',
                            validators: {
                                notEmpty: {
                                    message: "无需触发金额可填0"
                                },
                                regexp: {
                                    regexp: /^(0|\+?[1-9][0-9]*)$/,
                                    message: "只能输入正整数"
                                }
                            }
                        }
                    }
                });
            }
            //将日历中取出的值转换成后台所需的格式
            function datetime(time) {
                time1 = time.replace(/-/g, "/");
                time2 = new Date(time1).getTime();
                return time2;
            }
            $("#flowsgiveClose").click(function(){
                $('#form-quaninfo-update').data('bootstrapValidator', null);
            });
        //------------复制分享信息到其他门店-----------------------------
        //点击复制商品-----------------------------
        $("#button-goods-copy").click(function(){
            $("#sharesname_para").empty();
            var data = mtable.api(true).row({selected: true}).data();
            if(!data.awardid){
                alert("请选择您要复制的信息");
                return;
            }
            $("#sharesname_para").append('<span class="sharesname_span" data-id="'+data.awardid+'">分享赠送</span>')
            $("#dialog-copy-goods").modal('show');
            $.ajax({
                url:"/pipes/merchstore/query",
                data:{"bean":$.objectToString({merchid:system_merchuser.merchid})},
                type:"POST",
                dataType:"JSON",
                success:function(data){
                    console.log(data.rows);
                    var arr = data.rows;
                    var _li='';
                    for(var i=0;i<arr.length;i++){
                        _li+='<li><label><input type="checkbox">' +
                                '<input type="hidden" class="storeid" value="'+arr[i].store36id+'">'+arr[i].storename+'</label></li>'
                    }
                    $("#storeTree").html(_li);
                },
                error:function(err){
                    console.log(err);
                }
            });
        });
        $("#checkall").click(function(){
            var isChecked = $(this).prop("checked");
            $("#storeTree :checkbox").prop("checked", isChecked);
            var checklength =  $("#storeTree").find('input[type=checkbox]:checked').length;
            $("#checklength").html('已选择'+checklength+'家门店');
        });
        $('#storeTree').on('click','input[type=checkbox]',function(){
            var checklength =  $("#storeTree").find('input[type=checkbox]:checked').length;
            var length = $("#storeTree").find('input[type=checkbox]').length;
            $("#checklength").html('已选择'+checklength+'家门店');
            if(checklength==length){
                console.log("全选");
                $("#checkall").prop("checked", true);
            }else{
                $("#checkall").prop("checked", false);
            }
        });
        //点击复制到选择门店
        $("#copyto_store").click(function(){
            $(this).attr("disabled",true);
            var arr = $("#storeTree").find('input[type=checkbox]:checked').next('.storeid');
            var storeid = [];
            var nowstoreid = parseInt(common.getData("storeid")).toString(36);
            console.log(nowstoreid);
            for(var i=0;i<arr.length;i++){
                if(arr.eq(i).val()==nowstoreid){
                    continue;
                }
                storeid.push(arr.eq(i).val());
            }
            var shareid = $(".sharesname_span").data('id');
            if(storeid.length==0){
                alert('您还没有选择门店');
                $("#copyto_store").removeAttr('disabled')
            }else{
                $.get('/pipes/merchshare/copyshare2store?store36ids=['+storeid+"]&shareid='"+shareid+"'",function(res){
                    console.log(res);
                    res = JSON.parse(res);
                    if(res.retcode===0){
                        alert('赠送信息复制成功');
                        $("#dialog-copy-goods").modal('hide');
                    }
                    $("#copyto_store").removeAttr('disabled');
                })
            }
        });
        //----------------------下拉加载--------------------------
        var loading = false;//是否正在加载
        var current = 1;//默认当前是第一页
        var select_ajax = true;
        $("#storeTree").scroll(function () {
            if (loading) //如果正在请求 直接返回
                return;
            var scrollTop = jQuery(this).scrollTop();
            var scrollHeight = jQuery('#storeTree').height();
            var windowHeight = jQuery(this).height();
            if (scrollTop + windowHeight >= scrollHeight - 100) {
                if (select_ajax) {
                    getMoreData();//select_ajax为false ,表示没有更多了，不能请求ajax
                }
            }
        });
        //下拉加载列表
        function getMoreData() {
            loading = true;
            var html = "";
            current++;
            jQuery.ajax({
                type: "post",
                cache: false,
                dataType: "JSON",
                data: {
                    "bean":$.objectToString({merchid:system_merchuser.merchid}),
                    "flipper": "{limit:20,offset:"+(current-1)*20+"}",
                    "order": "DESC",
                    "start": current*20,
                    "length": 20,
                    "sort": "createtime"
                },
                url: "/pipes/merchstore/query",
                success: function (data) {
                    var arr = data.rows;
                    var _li='';
                    for(var i=0;i<arr.length;i++){
                        _li+='<li><label><input type="checkbox">' +
                                '<input type="hidden" class="storeid" value="'+arr[i].store36id+'">'+arr[i].storename+'</label></li>';
                    }
                    $("#storeTree").append(_li);
                    if (data.total>current*20) {
                        loading = false; //loding=false 表示下次继续可以请求
                    } else {
                        loading = true;
                        $("#storeTree").append('<li style="text-align: center">没有更多数据了</li>');
                    }
                },
                error: function (data) {
                    alert("数据加载失败");
                }
            });
        }
    }


</script>