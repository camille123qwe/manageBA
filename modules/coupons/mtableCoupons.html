<div class="page-title" style="margin-top:10px;">
    <ul class="filter_ul" style="margin: 0;padding: 0">
        <li><a id="button-quaninfo-create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增优惠券</a></li>
        <li><a id="button-quaninfo-update" href="javascript:void(0);"><i class="fa fa-plus"></i>更改优惠券</a></li>
    </ul>
</div>
<div class="panel-box">
    <div class="table-responsive" >
        <table id="table-quan-sheet" class="table" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>优惠券信息</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="dialog-quan-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="900" data-height="480" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" id="quanClose" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-quan-update" class="modal-title">修改商品</h4>
    </div>
    <div class="modal-body">
        <form id="form-quaninfo-update" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
            <input name="quanid" id="quanid" type="hidden">
            <input name="merchid" id="merchid" type="hidden">
            <input name="createtime" type="hidden">
            <table width="100%">
                <tbody>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >选择门店</label>
                            <div class="col-lg-8">
                                <select name="storeid" id="storeid_select" class="form-control">
                                    <option>门店分类</option>
                                </select>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >状 态</label>
                            <div class="col-lg-8" >
                                <select name="status" class="form-control" required=""   data-bv-trigger="blur"  data-bv-notempty-message="状态不能为空">
                                    <option value="10" style="color:green;">正常</option>
                                    <option value="20" style="color:#FF00FF;">待审批</option>
                                    <option value="30">隐藏</option>
                                    <option value="40">下架</option>
                                    <option value="70" style="color:red;">过期</option>
                                    <option value="80" style="color:red;">删除</option>
                                </select>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >优惠券标题</label>
                            <div class="col-lg-8">
                                <input class="form-control" name="quantitle">
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >赠送流量(M)</label>
                            <div class="col-lg-8" ><input type="number"  name="flowkbs" class="form-control" placeholder="赠送流量兆数,1G=1024M" ></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >有效期限(天数)</label>
                            <div class="col-lg-8" ><input name="validday" id="validday" placeholder="为0表示长期有效" class="form-control" ></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >通话时长(分)</label>
                            <div class="col-lg-8" >
                                <select name="voicetimes" class="form-control">
                                    <option value="0">不赠送</option>
                                    <option value="60">60分钟 -价值4.8元</option>
                                    <option value="100">100分钟 -价值8元</option>
                                    <option value="200">200分钟 -价值16元</option>
                                    <option value="500">500分钟 -价值40元</option>
                                    <option value="1000">1000分钟 -价值80元</option>
                                </select>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >起始时间</label>
                            <div class="col-lg-8" ><input  name="starttime" id="quanstarttime" placeholder="优惠起始时间" class="form-control"></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >赠送礼品</label>
                            <div class="col-lg-8" ><input  name="giftname" placeholder="不赠送则不填" class="form-control"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >截止时间</label>
                            <div class="col-lg-8" ><input  name="endtime" readonly id="endtime"  placeholder="优惠结束时间，长期有效则填0" class="form-control"></div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >代金金额(元)</label>
                            <div class="col-lg-8" ><input name="cashvalue" placeholder="输入赠送的代金券金额" class="form-control" ></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                            <label class="col-lg-3 control-label" >备注说明</label>
                            <div class="col-lg-8" ><textarea  name="remark" id="remark" class="form-control"></textarea></div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            <br>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3">
                    <button id="formbtn-quan-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function(){
        if(system_merchuser.type==10){
            $("#coupons-title").html('<a  href="javascript:openModule(\'modules/index/indexClick.html\',400);" style="color: #006dcc">商户首页</a>'+
                    '&gt;&gt;<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>' +
                    '&gt;&gt;<a href="javascript:openModule(\'modules/coupons/coupons.html\',401);" style="color: #006dcc">优惠管理</a>')
        }else{
            $("#coupons-title").html('<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>' +
                    '&gt;&gt;<a href="javascript:openModule(\'modules/coupons/coupons.html\',401);" style="color: #006dcc">优惠管理</a>')
        }
        //-----门店名称--------------
        $.ajax({
            cache: false,
            dataType: "json",
            type: "POST",
            data:{
                "bean":$.objectToString({storeid:common.getData('storeid')})
            },
            url: '/pipes/merchstore/query',
            error: function () {//请求失败处理函数
                alert('请求失败');
            },
            success: function (data) {
                if(data&&data.retcode>0){
                    alert(data.retinfo);
                }else{
                    var rows = data.rows||[];
                    $("#nowStorename").text(rows[0].storename);
                }
            }
        });
    });
    if (system_merchuser && system_merchuser.merchuserid) {
        var storeid = common.getData("storeid");
        var data = {
            storeid: storeid
        };
        $.ajax({
            url: "/pipes/merchquan/fluxpkgs",
            data: {},
            dataType: "JSON",
            type: "POST",
            async:false,
            success: function (res) {
                if (res && res.retcode > 0) {
                    alert(res.retinfo);
                } else {
                    qjflux = res || [];
                }
            },
            error: function (err) {
                console.log(err);
            }
        });
        fullCoupons = function(value,type,full){
            var _html = "", validtime = "", status = "", fluxpkgid = "", giftname = "";
            //有效期
            if (full.endtime == 0) {
                validtime = "自" + time(full.starttime) + "起长期永久有效";
            } else {
                validtime = time(full.starttime) + "至" + time(full.endtime);
            }
            //状态判断
            if (full.status === 10) {
                status = "<font color=green>正常</font>";
            } else if (full.status === 20) {
                status = "<font color=#FF00FF>待审批</font>";
            } else if (full.status === 80) {
                status = "<font color=red>删除</font>";
            } else {
                status = "<font color=red>未知</font>";
            }
            //流量获取
            var fluxpkgid = "";
            for (var j = 0; j < qjflux.length; j++) {
                if (full.fluxpkgid == qjflux[j].fluxpkgid) {
                    fluxpkgid = qjflux[j].pkgtitle
                }
            }
            //赠送礼品
            if (full.giftname) {
                giftname = full.giftname
            } else {
                giftname = '无'
            }
            //有效期
            var validday = "";
            if (full.validday != 0) {
                validday = "(" + full.validday + "天)"
            }
            //---------------------------------
            var endtime = "";
            if (full.endtime == 0) {
                endtime = 0
            } else {
                endtime = time(full.endtime)
            }

            var statustext = "";
            if (full.status == 80) {
                //statustext = '<button style="background: none;border: none;color: red;" value=' + str + '>已删除</button>'
                statustext="已删除";
            } else {
                //statustext = '<button class="button-quaninfo-update" style="background: none;border: none;color: blue;" value=' + str + '>删除</button>'
                statustext="正常";
            }
            //---流量 话费 礼物 语音 为空值时则不展示
            var fluxhtml = "", gifthtml = "", voicehtml = "", cashhtml = "", remarkhtml = "";
            if (fluxpkgid) {
                fluxhtml = '<div class="col-lg-6"><p style="margin-top: 10px">赠送流量:<span>' + fluxpkgid + '</span></p></div>';
            } else {
                fluxhtml = '&nbsp';
            }
            if (giftname != '无') {
                gifthtml = '<div class="col-lg-6"><p style="margin-top: 10px">赠送礼品:<span>' + giftname + '</span></p></div>'
            } else {
                gifthtml = '&nbsp';
            }
            if (full.voicetimes != 0) {
                voicehtml = '<div class="col-lg-6"><p style="margin-top: 10px">通话分钟:<span>' + full.voicetimes / 60 + '分钟</span></p></div>'
            } else {
                voicehtml = '&nbsp';
            }
            if (full.cashvalue != 0) {
                cashhtml = '<div class="col-lg-6"><p style="margin-top: 10px">代金券:<span>' + full.cashvalue / 100 + '元</span></p></div>';
            } else {
                cashhtml = '&nbsp';
            }
            if (full.maxcount == 0) {
                full.maxcount = "不限张数";
            }
            //------------------------------
            _html='<div class="col-lg-8" >'+
                    '<div class="panel-box" style="padding: 5px;position: relative;background: #f7c16c;color: white" id=" storebasic">'+
                    '<div class= "row">'+
                    '<div class="page-header" style="padding: 10px;margin : 0;">'+
                    '<h5 style="margin-left: 20px;color: white;display: inline-block">'+full.quantitle+'<small style="margin-left: 15px;color: white " >('+ status+')</small></h5>'+
                    '<p style="display: inline-block;position: absolute;right: 50px; " >'+ statustext+'</p></div></div >'+
                    '<div class="row" style="margin-left: 10px;" >'+ fluxhtml + gifthtml + voicehtml + cashhtml +' </div >'+
                    '<div class="row" style="margin-left: 10px;margin-bottom: 20px" >'+
                    '<div class="col-lg-6"><p> 发行张数:'+full.maxcount +' </p></div >'+ remarkhtml +' </div>' +
                    '<div class="row" style="display: inline-block;position: absolute;bottom: 0;right: 50px;">' +
                    '<p style="display: inline-block"> 有效期:'+ validtime +' <span >'+ validday +' </span></p></div></div></div>';
            return _html;
        };
        //商品列表
        var mtable = $('#table-quan-sheet').dataTable({
            iDisplayLength: 10,
            aLengthMenu: [10],
            ajax: {
                url: "/pipes/merchquan/query",
                data: function (f) {
                    f.bean = JSON.stringify(data);
                    f.sort = 'createtime';
                    f.order = 'DESC';
                    f.length = '5';
                },
                "aLengthMenu": [[5, 25, 50, -1], [5, 25, 50, "All"]]
            },
            columns: [
                {"data": "quantitle", render: fullCoupons},
            ]
        });
        function time(date) {
            var year = new Date(date).getFullYear();
            var month = new Date(date).getMonth() + 1;
            var date1 = new Date(date).getDate();
            if (month < 10) {
                month = "0" + month;
            }
            if (date1 < 10) {
                date1 = "0" + date1;
            }
            var result = year + "-" + month + "-" + date1;
            return result;
        }
        var t = new Date().toJSON();
        var t1 = new Date();
        var t2 = new Date(t1);
        t2.setDate(t1.getFullYear()+5);
        t2 = t2.toJSON();
        $("#quanstarttime").datetimepicker({
            format: "yyyy-mm-dd", //设置时间格式，默认值: 'mm/dd/yyyy'
            weekStart: 0, //一周从哪一天开始。0（星期日）到6（星期六）,默认值0
            startDate: new Date(t), //可以被选择的最早时间
            endDate: new Date(t2), //可以被选择的最晚时间
            daysOfWeekDisabled: "", //禁止选择一星期中的某些天，例子中这样是禁止选择周六和周日
            autoclose: true, //当选择一个日期之后是否立即关闭此日期时间选择器
            startView: 2, //点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
            minView: 2, //插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
            maxView: 4, //同理
            todayBtn: true, //是否在底部显示“今天”按钮
            todayHighlight: true, //是否高亮当前时间
            keyboardNavigation: true, //是否允许键盘选择时间
            language: 'zh-CN', //选择语言，前提是该语言已导入
            forceParse: true, //当选择器关闭的时候，是否强制解析输入框中的值。也就是说，当用户在输入框中输入了不正确的日期，选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中
            minuteStep: 5, //分钟的间隔
            pickerPosition: "bottom-left", //显示的位置，还支持bottom-left
            viewSelect: 2, //默认和minView相同
            showMeridian: true, //是否加上网格
            initialDate: new Date(t),//初始化的时间
            zIndex: 1080
        }).on('changeDate',function(){
            endvalue();
        });
        $("#validday").on('change',function(){
            endvalue();
        });
        function endvalue(){
            if($("#validday").val()==0){
                $("#endtime").val("0");
            }else{
                var v = $("#validday").val();
                var t = $("#quanstarttime").val();
                t= datetime(t);
                var t2 = new Date(t);
                var t2 = t2.setDate(t2.getDate()+Number(v));
                var year = new Date(t2).getFullYear();
                var month =  new Date(t2).getMonth()+1;
                var date = new Date(t2).getDate();
                if(month<10){
                    month = "0"+month;
                }
                if(date<10){
                    date = "0"+date;
                }
                var result = year +"-"+month+"-"+date;
                $("#endtime").val(result);
            }
        }
        //查询排序
        $("#filter-user-qrybtn").click(function(){
            mtable.api(true).draw(false);
            $('#table-storeinfo-sheet').dataTable().fnPageChange(0);
        });
        //点击新增优惠券
        $("#button-quaninfo-create").bind("click", function () {
            $("#form-quaninfo-update").form('reset');
            $("#quanid").val("");
            couponsvalidator();
            $('#dialog-quan-update').modal('show');
        });
        //--------------点击修改商品------------------------------
        $("#button-quaninfo-update").click(function(){
            var data = mtable.api(true).row({selected: true}).data();
            if (!data || !data.quanid) {
                alert("请选择一条记录！");
                return;
            }
            $("#form-quaninfo-update").form('reset');
            couponsvalidator();
            data.cashvalue = data.cashvalue/100;
            data.voicetimes = data.voicetimes/60;
            data.flowkbs = data.flowkbs/1024;
            data.starttime = time(data.starttime).replace(/\//g,"-");
            if(data.endtime==0){
                data.endtime = 0
            }else{
                data.endtime = time(data.endtime).replace(/\//g,"-");
            }
            $("#form-quaninfo-update").form('load', data);
            var markcontent=$("#remark").val();
            markcontent=markcontent.replace(/<br>/g,"");
            $("#remark").val(markcontent);
            $('#dialog-quan-update').modal('show');

        });

        //--------------新增&&修改商品提交------------------------------
        $("#formbtn-quan-update").click(function () {
            var form =$("#form-quaninfo-update");
            var json = form.serializeJson();
            var data = "";
            var content=json.remark;
            content=content.replace(/\n/g,'<br>');
            json.remark=content;
            json.starttime = datetime(json.starttime);
            if(json.endtime==0){
                json.endtime = 0
            }else{
                json.endtime = datetime(json.endtime);
            }
            json.voicetimes = json.voicetimes*60;
            json.flowkbs = json.flowkbs*1024;
            json.cashvalue = json.cashvalue *100;
            //-----去json数据中的空格-----------------
            var json1= {};
            $.each(json,function(key,value){
                value = (value + "").replace(/\s/g,'');
                json1[key] = value;
            });
            json = json1;
            //---------------------------------
            var data = "";
            if(json.quanid==""){
                data = {"bean":$.objectToString(json)}
            }else{
                var cols = [];
                for(key in json){
                    if(key=="createtime"||key=="quanid"){
                        continue
                    }
                    cols.push(key);
                }
                data = {
                    "bean":$.objectToString(json),
                    "cols":$.objectToString(cols)
                }
            }
            $('#form-quaninfo-update').bootstrapValidator('validate');
            if( $('#form-quaninfo-update').data('bootstrapValidator').isValid()) {
                $.ajax({
                    url: "/pipes/merchquan/update",
                    data: data,
                    dataType: "JSON",
                    type: "POST",
                    success: function (data) {
                        if (data && data.retcode > 0) {
                            alert(data.retinfo)
                        } else {
                            $("#dialog-quan-update").modal('hide');
                            mtable.api(true).draw(false);
                            $('#form-quaninfo-update').data('bootstrapValidator', null);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }
        });
        //-------关闭按钮摧毁验证-----------------------------
        $("#quanClose").on("click",function(){
            $("#form-quaninfo-update").data('bootstrapValidator').destroy();
            $('#form-quaninfo-update').data('bootstrapValidator', null);
        });
        //将日历中取出的值转换成后台所需的格式
        function datetime(time){
            time1=time.replace(/-/g,"/");
            time2=new Date(time1).getTime();
            return time2;
        }
        function couponsvalidator() {
            $('#form-quaninfo-update').bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {/*输入框不同状态，显示图片的样式*/
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {/*验证*/
                    quantitle: {/*键名和input name值对应*/
                        message: 'The quantitle is not valid',
                        validators: {
                            notEmpty: {/*非空提示*/
                                message: '优惠券标题不能为空'
                            }
                        }
                    },
                    flowkbs: {
                        message:'',
                        validators: {
                            regexp: {
                                regexp:/^(0|\+?[1-9][0-9]*)$/,
                                message:"只能输入正整数"
                            }
                        }
                    },
                    voicetimes: {
                        message:'',
                        validators: {
                            regexp: {
                                regexp:/^(0|\+?[1-9][0-9]*)$/,
                                message:"只能输入正整数"
                            }
                        }
                    },
                    cashvalue: {
                        message:'',
                        validators: {
                            regexp: {
                                regexp:/^(0|\+?[1-9][0-9]*)$/,
                                message:"只能输入正整数"
                            }
                        }
                    },
                    validday: {
                        message:'',
                        validators: {
                            notEmpty:{
                                message:"有效期不能为空,长久有效可填0"
                            },
                            regexp: {
                                regexp:/^(0|\+?[1-9][0-9]*)$/,
                                message:"只能输入正整数"
                            }
                        }
                    },
                    starttime: {
                        message:'',
                        validators: {
                            notEmpty:{
                                message:"请选择开始日期"
                            }
                        }
                    }
                }
            });
        }
    }


</script>