<div class="row">
    <p style="padding: 15px 0 0 15px;color: #006dcc" id="roleCharge-title">
        <a  href="javascript:openModule('modules/index/indexClick.html',400);" style="color: #006dcc">商户首页</a>
        &gt;&gt;<a href="javascript:openModule('modules/store/storeindex.html',101);" style="color: #006dcc">门店首页</a>
        &gt;&gt;<a href="javascript:openModule('modules/member/roleCharge.html',402);" style="color: #006dcc">角色权限管理</a>
        <span style="color:#114da9;margin-left: 20px">当前门店:<span id="nowStorename"></span></span>
    </p>
</div>
<div class="row">
    <div class="col-lg-4">
        <div class="panel-box">
            <div class="table-responsive" >
                <div class="page-title" style="margin-top:10px;">
                    <ul class="filter_ul" style="margin: 0;padding: 0">
                        <li><a id="button-role-create" href="javascript:void(0);"><i class="fa fa-plus"></i>添加角色</a></li>
                        <li><a id="button-role-update" href="javascript:void(0);"><i class="fa fa-edit"></i>更改角色</a></li>
                        <li><a id="allmark" href="javascript:void(0);">全部会员</a></li>
                    </ul>
                </div>
                <table id="table-mark-sheet" class="table table-hover" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th></th>
                        <th>角色名称</th>
                        <th>角色层级</th>
                        <th>父级ID</th>
                        <th>状态</th>
                        <th>创建日期</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="panel-box">
            <div class="table-responsive">
                <div class="page-title" style="margin-top:10px;">
                    <ul class="filter_ul" style="margin: 0;padding: 0">
                        <li><a id="button-custmark-create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增用户角色</a></li>
                        <li><a id="button-custname-create" href="javascript:void(0);"><i class="fa fa-plus"></i>添加用户昵称备注</a></li>
                    </ul>
                </div>
                <table id="table-cust-sheet" class="table table-hover" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th></th>
                        <th>门店ID</th>
                        <th>会员ID</th>
                        <th>备注昵称</th>
                        <th>会员网名</th>
                        <th>推送类型</th>
                        <th>电话号码</th>
                        <th>角色集合</th>
                        <th>关注时间</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="dialog-role-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="500" data-height="200" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" id="quanClose" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-quan-update" class="modal-title">新增角色<span style="font-size: 12px;font-weight: 100">(注意:角色不能超过20个)</span></h4>
    </div>
    <div class="modal-body">
        <form id="form-role-update" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
            <input name="createtime" type="hidden">
            <input name="merchroleid" id="merchroleid" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label" >状 态</label>
                <div class="col-lg-8" >
                    <select name="status" class="form-control" required=""   data-bv-trigger="blur"  data-bv-notempty-message="状态不能为空">
                        <option value="10" style="color:green;">正常</option>
                        <option value="20" style="color:#FF00FF;">待审批</option>
                        <option value="80" style="color:red;">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label" >角色名称</label>
                <div class="col-lg-8">
                    <input class="form-control" name="rolename" id="markgroup">
                </div>
            </div>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3">
                    <button id="formbtn-role-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="dialog-custmark-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="500" data-height="200" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-custmark-update" class="modal-title">选择用户角色&nbsp;&nbsp;<span style="font-size: 12px;font-weight: 100">(注意:用户角色可以选择多个)</span></h4>
    </div>
    <div class="modal-body">
        <form id="form-custmark-create" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
            <div class="form-group">
                <div class="col-lg-12" id="markname">

                </div>
            </div>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3" style="margin-top: 30px">
                    <button id="formbtn-custmark-create" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>
<div id="dialog-nickname-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="500" data-height="300" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">设置会员昵称</h4>
    </div>
    <div class="modal-body">
        <form id="form-nickname-create" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
            <div class="form-group">
                <label class="col-lg-3 control-label">当前会员名</label>
                <div class="col-lg-8">
                    <input class="form-control" id="custname" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label">添加昵称备注</label>
                <div class="col-lg-8">
                    <input class="form-control" id="nickname">
                </div>
            </div>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3" style="margin-top: 30px">
                    <button id="nickname-create" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    {
        if (system_merchuser && system_merchuser.merchuserid) {
            $(document).ready(function(){
                if(system_merchuser.type==10){
                    $("#roleCharge-title").html('<a  href="javascript:openModule(\'modules/index/indexClick.html\',400);" style="color: #006dcc">商户首页</a>'+
                            '&gt;&gt;<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>'+
                            '&gt;&gt;<a href="javascript:openModule(\'modules/member/roleCharge.html\',402);" style="color: #006dcc">角色权限管理</a>')
                }else{
                    $("#roleCharge-title").html('<a href="javascript:openModule(\'modules/store/storeindex.html\',101);" style="color: #006dcc">门店首页</a>'+
                            '&gt;&gt;<a href="javascript:openModule(\'modules/member/roleCharge.html\',402);" style="color: #006dcc">角色权限管理</a>')
                }
                $("#table-mark-sheet").after('<p><span style="color: red;">*</span>点击任意一行角色即可看到所属角色的会员</p>' +
                        '<p><span style="color: red;">*</span>点击全部会员即可看到全部会员</p>'
                );
                $("#allmark").css('cursor','pointer');
                $(".pull-left").show();
                $("#menu").show();
                $("body").removeClass("widescreen");
            });
            //角色列表
            var storeid=common.getData('storeid');
            if(!storeid){
                storeid = 0;
            }
            var storename=common.getData('storename');
            $("#nowStorename").text(storename);
            var mtable = $('#table-mark-sheet').dataTable({
                iDisplayLength: 10,
                aLengthMenu: [10],
                ajax: {
                    url: "/pipes/b2buser/role/query",
                    data: function (f) {
                        f.bean = JSON.stringify({

                        });
                        f.sort = 'createtime';
                        f.order = 'DESC';
                        f.length = '10';
                    }
                },
                columnDefs: [
                    {
                        className: 'select-checkbox',
                        targets: 0
                    }
                ],
                columns: [
                    {"data": "", render: $.defrender},
                    {"data": "rolename", render: $.defrender},
                    {"data": "rolelevel", render: $.defrender},
                    {"data": "p_roleid", render: $.defrender},
                    {"data": "status", render: defStatusRender},
                    {"data": "createtime", render: Date.DateFormatter}
                ]
            });
            //查询排序
            $("#filter-user-qrybtn").click(function(){
                mtable.api(true).draw(false);
                $('#table-storeinfo-sheet').dataTable().fnPageChange(0);
            });
            //点击新增用户角色
            $("#button-role-create").bind("click", function () {
                $("#form-role-update").form('reset');
                $("#merchroleid").val("");
                merchroleidvalidator();
                $('#dialog-role-update').modal('show');
            });
            //--------------点击修改用户角色------------------------------
            $("#button-role-update").click(function(){
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.merchroleid) {
                    alert("请选择一条记录！");
                    return;
                }
                $("#form-role-update").form('reset');
                merchroleidvalidator();
                $("#form-role-update").form('load', data);
                $('#dialog-role-update').modal('show');
            });
            //--------------新增&&修改角色提交------------------------------
            $("#formbtn-role-update").click(function () {
                $(this).attr("disabled",true);
                var form =$("#form-role-update");
                var json = form.serializeJson();
                json.storeid = storeid;
                var data = "";
                var cols = [];
                if(json.createtime==""){
                    data = {
                        "bean":$.objectToString(json),
                        "merchuserids":$.objectToString([])
                    }
                }else{
                    for(key in json){
                        cols.push(key)
                    }
                    data = {
                        "bean":$.objectToString(json),
                        "merchuserids":$.objectToString([]),
                        "cols":$.objectToString(cols)
                    }
                }
                $('#form-role-update').bootstrapValidator('validate');
                if ($('#form-role-update').data('bootstrapValidator').isValid()) {
                    $.ajax({
                        url: "/pipes/b2buser/role/update",
                        data: data,
                        dataType: "JSON",
                        type: "POST",
                        success: function (data) {
                            $("#formbtn-role-update").removeAttr("disabled");
                            if (data && data.retcode > 0) {
                                alert(data.retinfo);
                                return;
                            } else {
                                $("#dialog-role-update").modal('hide');
                                mtable.api(true).draw(false);
                                $('#form-role-update').data('bootstrapValidator', null);
                                alert("保存成功");
                            }
                        },
                        error: function (error) {
                            $("#formbtn-role-update").removeAttr("disabled");
                            console.log(error);
                            alert("请求失败");
                            return;
                        }
                    });
                }
            });
            //-------关闭按钮摧毁验证-----------------------------
            $("#quanClose").on("click",function(){
                $("#form-role-update").data('bootstrapValidator').destroy();
                $('#form-role-update').data('bootstrapValidator', null);
            });
            /*-----------------会员列表--------------------------------------*/
            //角色列表
            custuser36id = function(value){
                return parseInt(value,10).toString(36)
            };
            store36id = function(value){
                return parseInt(value,10).toString(36)
            };
            var mtable2 = $('#table-cust-sheet').dataTable({
                iDisplayLength: 10,
                aLengthMenu: [10],
                ajax: {
                    url: "/pipes/merchcust/querycusts",
                    data: function (f) {
                        f.bean = JSON.stringify({
                            storeid:storeid,
                            merchroleids:$("#hiddenmerchroleids").val()==0?[""]:[$("#hiddenmerchroleids").val()]
                        });
                        f.sort = 'followtime';
                        f.order = 'DESC';
                        f.length = '10';
                    }
                },
                columnDefs: [
                    {
                        className: 'select-checkbox',
                        targets: 0
                    }
                ],
                columns: [
                    {"data": "", render: $.defrender},
                    {"data": "storeid", render: store36id},
                    {"data": "custuserid", render: custuser36id},
                    {"data": "nickname", render: $.defrender},
                    {"data": "custusername", render: $.defrender},
                    {"data": "pushtype", render: function(value){
                        if(value==10){
                            return "允许推送";
                        }else{
                            return "屏蔽推送";
                        }
                    }},
                    {"data": "custmobilex", render:  $.defrender},
                    {"data": "marks", render:  $.defrender},
                    {"data": "followtime", render: Date.DateFormatter}
                ]
            });
            //点击新增用户角色
            $("#button-custmark-create").click(function(){
                var data = mtable2.api(true).row({selected: true}).data();
                if (!data || !data.storeid) {
                    alert("请选择一条记录！");
                    return;
                }
                $.ajax({
                    url: "/pipes/role/query",
                    data:{"bean":$.objectToString({storeid:data.storeid})},
                    type:"post",
                    dataType:"JSON",
                    success:function(res){
                        var _html="";
                        var rows = res.rows||[];
                        var arr= data.marks;
                        var selectmarkname ="";
                        if(arr.length==0){
                            for(var i=0;i<rows.length;i++){
                                _html += '<label class="col-lg-3"><input name="merchroleid" class="merchroleid" value="'+rows[i].merchroleid+'" type="hidden"><input type="checkbox" class="markname">'+rows[i].markname+'</label>';
                            }
                        }else{
                            for(var i=0;i<rows.length;i++){
                                for(var j=0;j<arr.length;j++){
                                    if(arr[j]==rows[i].markname){
                                        selectmarkname = '<input type="checkbox" class="markname" checked="checked">'+rows[i].markname+'</label>';
                                        break;
                                    }else{
                                        selectmarkname = '<input type="checkbox" class="markname">'+rows[i].markname+'</label>';
                                    }
                                }
                                _html+=' <label class="col-lg-3">' +
                                        '<input name="merchroleid" class="merchroleid" value="'+rows[i].merchroleid+'" type="hidden">' +selectmarkname;
                            }
                        }
                        $("#dialog-custmark-update").modal('show');
                        $("#markname").html(_html);
                    },
                    error:function(err){
                        console.log(err)
                    }
                });
            });
            //点击提交新增用户角色
            $("#formbtn-custmark-create").click(function(){
                $(this).attr("disabled",true);
                var data = mtable2.api(true).row({selected: true}).data();
                var store36id=tx(data.storeid);
                var custuser36id=tx(data.custuserid);
                var arr= $("#dialog-custmark-update").find(".markname");
                var marksname=[];
                for(var i=0;i<arr.length;i++){
                    if(arr.eq(i).is(":checked")){
                        marksname.push(arr.eq(i).prev().val());
                    }
                }
                $.post('/pipes/merchcust/updatemark/custuser36id:'+custuser36id+'/store36id:'+store36id+'?merchroleids='+"["+marksname+"]",function(res){
                    res = JSON.parse(res);
                    $("#formbtn-custmark-create").removeAttr("disabled");
                    if(res.retcode===0){
                        $("#dialog-custmark-update").modal('hide');
                        mtable2.api(true).draw(false);
                    }
                });
            });
            //点击添加昵称按钮
            $("#button-custname-create").click(function(){
                var data = mtable2.api(true).row({selected: true}).data();
                if (!data || !data.storeid) {
                    alert("请选择一条记录！");
                    return;
                }
                $('#dialog-nickname-update').modal('show');
                $("#custname").val(data.custusername);
                $("#nickname").val(data.nickname||"");
            });
            //点击提交添加昵称
            $("#nickname-create").click(function(){
                var data = mtable2.api(true).row({selected: true}).data();
                var store36id=tx(data.storeid);
                var custuser36id=tx(data.custuserid);
                var nickname = $("#nickname").val();
                $.post('/pipes/merchcust/updatenickname/custuser36id:'+custuser36id+'/store36id:'+store36id+'?nickname="'+nickname+'"',function(res){
                    $('#dialog-nickname-update').modal('hide');
                    mtable2.api(true).draw(false);
                })
            });
            //36进制转换方法
            function tx(value){
                return parseInt(value,10).toString(36)
            }
            //点击角色进行会员的筛选
            $("#table-mark-sheet").on('click','td',function(){
                var cols=[];
                var data = mtable.api(true).row({selected: true}).data();
                if(data&&data.merchroleid){
                    cols.push(data.merchroleid);
                    $("#hiddenmerchroleids").val(cols);
                    mtable2.api(true).draw(false)
                }
            });
            $("#allmark").click(function(){
                $("#hiddenmerchroleids").val("");
                mtable2.api(true).draw(false);
            });
            //角色验证
            function merchroleidvalidator() {
                $('#form-role-update').bootstrapValidator({
                    message: 'This value is not valid',
                    feedbackIcons: {/*输入框不同状态，显示图片的样式*/
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {/*验证*/
                        markname: {/*键名和input name值对应*/
                            message: 'The markname is not valid',
                            validators: {
                                notEmpty: {/*非空提示*/
                                    message: '角色名称不能为空'
                                }
                            }
                        }
                    }
                });
            }
            //绑定回车键事件
            $("#markgroup").keydown(function(event){
                event=document.all?window.event:event;
                if((event.keyCode || event.which)==13){
                    $("#formbtn-role-update").trigger("click");
                }
            });
        }
    }
</script>